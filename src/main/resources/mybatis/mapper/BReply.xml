<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.healthplan.work.mapper.BReplyMapper">


<!-- 댓글 추가 -->
    <!-- 댓글 추가 -->
    <insert id="addReply" parameterType="com.healthplan.work.vo.BReplyEntity">
        INSERT INTO BREPLY (bno, mno, rComment, rRegdate, status)
        VALUES (#{bno}, #{mno}, #{rComment, jdbcType=VARCHAR}, SYSDATE, #{status, jdbcType=VARCHAR})
    </insert>

    <!-- 첨부 파일 삽입 -->
    <insert id="insertAttachedFile" parameterType="map">
        INSERT INTO BATTACHED (bno, fileName)
        VALUES (#{bno}, #{fileName})
    </insert>



    <!-- 모든 댓글을 가져오는 쿼리 -->
    <select id="listReplies" resultType="com.healthplan.work.vo.BReplyEntity">
        SELECT 
            r.rno, 
            r.mno, 
            r.bno, 
            r.rComment, 
            <!-- r.rRegdate, --> 
            TO_CHAR(r.rRegdate, 'YYYY-MM-DD') AS rRegdate,
            r.status,
            b.chno, 
            a.aNo, 
            a.fileName
        FROM 
            BREPLY r
        LEFT JOIN 
            BOARD b ON r.bno = b.bno
        LEFT JOIN 
            BATTACHED a ON r.bno = a.bno
        ORDER BY 
            r.rno
    </select>

    <!-- 댓글 수정 -->
    <update id="updateReply" parameterType="com.healthplan.work.vo.BReplyEntity">
        UPDATE BREPLY 
        SET rComment = #{rComment}, status = #{status}
        WHERE rno = #{rno}
    </update>

   <!-- 댓글 삭제 -->
    <delete id="deleteReply" parameterType="int">
        DELETE FROM BREPLY WHERE rno = #{rno}
    </delete>

    <select id="countTotalReplies" resultType="int">
        SELECT COUNT(*) FROM BREPLY
    </select>


    <select id="listAll" resultType="com.healthplan.work.vo.BReplyEntity">
        SELECT
            r.rno,
            r.bno,
            b.chno,
            r.mno,
            r.rComment,
            a.aNo,
            a.fileName,
            r.rRegdate,
            r.status
        FROM
            BREPLY r
        LEFT JOIN
            BATTACHED a ON r.bno = a.bno
        LEFT JOIN
            BOARD b ON r.bno = b.bno
        ORDER BY
            r.rno DESC
    </select>

    <!-- 댓글 최근리스트 -->
    <select id="listRecentReplies" parameterType="map" resultType="com.healthplan.work.vo.BReplyEntity">
        SELECT r.rno, r.bno, r.chno, r.mno, r.rComment, a.aNo, a.fileName, r.rRegdate, r.status
        FROM BREPLY r
        LEFT JOIN BATTACHED a ON r.bno = a.bno
        ORDER BY r.rno DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <!-- 댓글 등록 -->
    <insert id="insertReply" parameterType="com.healthplan.work.vo.BReplyEntity">
        INSERT INTO BREPLY (bno, rComment, rRegdate, fileName)
        VALUES (#{bno}, #{rComment}, sysdate, #{fileName})
    </insert>

    <!-- 댓글 파일첨부 -->
 <!--   <insert id="insertFile" parameterType="com.healthplan.domain.BAttachedVO">
        INSERT INTO BATTACHED (bno, fileName, uploadPath)
        VALUES (#{bno}, #{fileName}, #{uploadPath})
    </insert>-->




</mapper>

